<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Administración</title>
    <link rel="stylesheet" href="styles.css"> <!-- Añade tu archivo de CSS aquí -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Dashboard de Administración</h2>

<div id="dashboard">
    <!-- Resumen Financiero -->
    <section id="financialSummary">
        <h3>Resumen Financiero</h3>
        <p>Ingresos mensuales: <span id="monthlyIncome"></span></p>
        <p>Pagos pendientes: <span id="pendingPayments"></span></p>
        <p>Membresías activas:</p>
        <ul id="activeMemberships"></ul>
        <div id="incomeChart" style="width: 100%; height: 400px;"></div>
    </section>

    <!-- Estadísticas de Clientes -->
    <section id="clientStatistics">
        <h3>Estadísticas de Clientes</h3>
        <p>Total de clientes activos: <span id="activeClients"></span></p>
        <p>Clientes nuevos este mes: <span id="newClientsThisMonth"></span></p>
        <p>Clientes por tipo de membresía:</p>
        <ul id="clientsByMembershipType"></ul>
    </section>

    <!-- Actividades y Asistencias -->
    <section id="activities">
        <h3>Actividades y Asistencias</h3>
        <p>Asistencias diarias: <span id="dailyAttendances"></span></p>
        <div id="peakHoursChart" style="width: 100%; height: 400px;"></div>
        <h4>Historial de accesos reciente</h4>
        <ul id="recentAccessHistory"></ul>
        <h4>Clientes con más asistencias</h4>
        <ul id="topAttendees"></ul>
    </section>

    <!-- Alertas y Notificaciones -->
    <section id="alerts">
        <h3>Alertas y Notificaciones</h3>
        <ul id="paymentAlerts"></ul>
        <ul id="membershipExpiryAlerts"></ul>
    </section>

    <!-- Acceso rápido a Funcionalidades -->
    <section id="quickAccess">
        <h3>Acceso rápido</h3>
        <button onclick="registerNewClient()">Registro de nuevos clientes</button>
        <button onclick="registerPayment()">Registro de pago</button>
        <button onclick="manageMemberships()">Administración de membresías</button>
        <button onclick="viewClientHistory()">Historial de clientes</button>
    </section>

    <!-- Reportes -->
    <section id="reports">
        <h3>Reportes</h3>
        <button onclick="generateReport()">Generar Reporte</button>
        <button onclick="exportData()">Exportar datos</button>
    </section>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('token');
        if (!token) {
            alert("Debe iniciar sesión para acceder al dashboard.");
            window.location.href = 'login.html';
            return;
        }

        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        // Resumen Financiero
        await fetchFinancialSummary(headers);

        // Estadísticas de Clientes
        await fetchClientStatistics(headers);

        // Actividades y Asistencias
        await fetchActivityData(headers);

        // Alertas y Notificaciones
        await fetchAlerts(headers);
    });

    async function fetchData(url, headers, successCallback) {
    try {
        const response = await fetch(url, { headers });
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        const data = await response.json();
        successCallback(data);
    } catch (error) {
        console.error(`Error fetching data from ${url}:`, error);
        alert('Ocurrió un error al cargar los datos. Inténtelo más tarde.');
    }
}

async function fetchFinancialSummary(headers) {
    fetchData('https://api-gymya-api.onrender.com/api/financial-summary', headers, (data) => {
        document.getElementById("monthlyIncome").innerText = data.monthlyIncome;
        document.getElementById("pendingPayments").innerText = data.pendingPayments;
        document.getElementById("activeMemberships").innerHTML = data.activeMemberships.map(m => `<li>${m.type}: ${m.count}</li>`).join('');
        renderChart("incomeChart", data.incomeChartData);
    });
}

    async function fetchClientStatistics(headers) {
    fetchData('https://api-gymya-api.onrender.com/api/client-statistics', headers, (data) => {
        document.getElementById("activeClients").innerText = data.activeClients;
        document.getElementById("newClientsThisMonth").innerText = data.newClientsThisMonth;
        document.getElementById("clientsByMembershipType").innerHTML = data.clientsByMembershipType.map(c => `<li>${c.type}: ${c.count}</li>`).join('');
    });
}

async function fetchActivityData(headers) {
    fetchData('https://api-gymya-api.onrender.com/api/activity-data', headers, (data) => {
        document.getElementById("dailyAttendances").innerText = data.dailyAttendances;
        document.getElementById("recentAccessHistory").innerHTML = data.recentAccessHistory.map(a => `<li>${a.clientName}: ${a.accessTime}</li>`).join('');
        document.getElementById("topAttendees").innerHTML = data.topAttendees.map(t => `<li>${t.name} - ${t.attendanceCount}</li>`).join('');
        renderChart("peakHoursChart", data.peakHoursData);
    });
}

async function fetchAlerts(headers) {
    fetchData('https://api-gymya-api.onrender.com/api/alerts', headers, (data) => {
        document.getElementById("paymentAlerts").innerHTML = data.paymentAlerts.map(p => `<li>${p}</li>`).join('');
        document.getElementById("membershipExpiryAlerts").innerHTML = data.membershipExpiryAlerts.map(m => `<li>${m}</li>`).join('');
    });
}

    function renderChart(containerId, data) {
        // Asume que estás usando una biblioteca como Chart.js para las gráficas
        const ctx = document.getElementById(containerId).getContext('2d');
        new Chart(ctx, { type: 'line', data: data });
    }

    function registerNewClient() { window.location.href = "register-client.html"; }
    function registerPayment() { window.location.href = "register-payment.html"; }
    function manageMemberships() { window.location.href = "manage-memberships.html"; }
    function viewClientHistory() { window.location.href = "client-history.html"; }
    function generateReport() { /* lógica de generación de reportes */ }
    function exportData() { /* lógica de exportación de datos */ }
</script>

</body>
</html>
